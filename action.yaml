name: SemVer Release Version
description: Utilized for creating releases of projects

# Inputs
inputs:
  nexus_repo_id:
    description: "Nexus Repository ID" 
    required: false
    default: "maven-snapshots"
  nexus_repo_username:
    description: "Nexus Repository Username" 
    required: false 
    default: "admin"
  is_tag:
    description: "Check if running on tag"
    required: false
    default: 'false'
  nexus_repo_password:
    description: "Nexus Repository Password"  
    required: true
  nexus_repo_url:
    description: "Nexus Repository URL"
    required: false 
    default: "https://nexus.tinkarbuild.com" 
  github_token:
    description: "GitHub Token"
    required: true
  gpg_passphrase:
    description: "GPG Passphrase"
    required: true
  gpg_key:
    description: "GPG Key"
    required: true
  ossrh_username:
    description: "OSSRH USERNAME"
    required: true
  ossrh_token:
    description: "OSSRH Token"
    required: true
  release_notes:
    description: "Release Notes"
    required: false
  repo_name: 
    description: "Repo Name"
    required: true
  branch_name: 
    description: "Branch Name" 
    required: true 
  ikmdevops_pat:
    description: "PAT TOKEN for IKMDevops User"
    required: true

outputs:
  release_upload_url:
    description: "Release Url"
    value: ${{ steps.create_release.outputs.upload_url }}


runs:
  using: "composite"
  steps:
     - name: Checkout Repository
       uses: actions/checkout@v4
       with:
         repository: ${{inputs.repo_name}}
         ref: ${{inputs.branch_name}}
    
     - name: Setup Java
       uses: actions/setup-java@v4
       with:
            distribution: 'zulu'
            java-version: '21'
            server-id: ossrh
            server-username: MAVEN_USERNAME
            server-password: MAVEN_CENTRAL_TOKEN
            gpg-private-key: ${{inputs.gpg_key}}
            gpg-passphrase: MAVEN_GPG_PASSPHRASE

     - name: Maven Settings File
       uses: whelk-io/maven-settings-xml-action@v22
       with:
        servers: '[{"id": "${{ inputs.nexus_repo_id }}", "username": "${{inputs.nexus_repo_username}}", "password": "${{inputs.nexus_repo_password}}"}]'
        profiles: '[{"id": "${{inputs.nexus_profile}}", "properties": {"altDeploymentRepository": "${{  inputs.nexus_repo_id }}::${{ inputs.nexus_repo_url }}/repository/${{ inputs.nexus_repo_id }}"}}]'
        active_profiles: '["${{inputs.nexus_profile}}"]' 
        output_file: .m2/settings.xml

     - name: Maven Build
       shell: bash
       run: |
          ./mvnw clean install -U \
            --batch-mode \
            -e \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            -Dmaven.build.cache.enabled=false \

     - name: Deploy To Nexus
       shell: bash
       if: github.event.repository.name != 'jpms-deps'
       run: |
          ./mvnw deploy \
            --batch-mode \
            -e \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            -DskipTests \
            -DskipITs \
            -s '/home/runner/work/${{github.event.repository.name}}/${{github.event.repository.name}}/.m2/settings.xml'\
            -DrepositoryId='${{ inputs.nexus_repo_id }}'
    
     - name: Publish To OSSRH (Maven Central Staging)
       shell: bash
       if: inputs.is_tag == 'true'
       run: |
            ./mvnw deploy -U\
                  --batch-mode \
                  -e \
                  -U \
                  -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                  -DskipTests \
                  -DskipITs \
                  -Dmaven.main.skip \
                  -Dmaven.test.skip \
                  -DrepositoryId=ossrh \
                  -DrepositoryIdOSSRH='true' \
                  -PstageOSSRH \
                  -Dmaven.build.cache.enabled=false
       env:
          MAVEN_USERNAME: ${{ inputs.ossrh_username }}
          MAVEN_CENTRAL_TOKEN: ${{ inputs.ossrh_token }}
          MAVEN_GPG_PASSPHRASE: ${{ inputs.gpg_passphrase }}

     - name: Create Release
       id: create_release
       if: inputs.is_tag == 'true'
       uses: mcomnoco/create-release-action@v2.0.5
       env:
          GITHUB_TOKEN: ${{ inputs.github_token }}
       with:
          tag_name: ${{ inputs.branch_name }}
          release_name: Release ${{ inputs.branch_name }}
          body: |
            ${{inputs.release_notes}}
          draft: false
          prerelease: false

     